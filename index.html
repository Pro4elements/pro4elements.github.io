
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>4ELEMENTS Diagnostic PRO — VPD + IA (UNA SOLA PÁGINA)</title>
<meta name="theme-color" content="#101317"/>
<style>
  :root{
    --bg:#101317; --bg2:#0a0d10; --card: rgba(16,18,22,0.80); --glass: rgba(18,20,24,0.55);
    --border:#1e2630; --text:#f6fbff; --muted:#b6c0ca;
    --accent:#22e06b; --accent2:#58b7ff; --accent3:#ff6b6b;
    --shadow: 0 10px 30px rgba(0,0,0,.38), inset 0 1px 0 rgba(255,255,255,.02);
    --radius: 18px; --duration: 28s;
    --ok:#22e06b; --warn:#ffb703; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
    color:var(--text); background: radial-gradient(900px 600px at 15% -10%, rgba(88,183,255,0.12), transparent 55%),
                        radial-gradient(900px 600px at 110% -5%, rgba(34,224,107,0.10), transparent 60%),
                        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
  }

  header.hero{
    position:sticky; top:0; z-index:70; backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
    background: linear-gradient(180deg, rgba(16,20,24,.95), rgba(16,20,24,.75));
    box-shadow: 0 20px 40px rgba(0,0,0,.45); overflow:hidden;
  }
  header.hero::before{
    content:""; position:absolute; inset:0 0 auto 0; height:3px;
    background: linear-gradient(90deg, var(--accent2), var(--accent), var(--accent3), var(--accent2));
    filter: drop-shadow(0 0 10px rgba(88,183,255,.55));
    animation: sweep 4s linear infinite; background-size: 300% 100%;
  }
  @keyframes sweep { to { background-position: 300% 0; } }

  .container{max-width:1200px; margin:0 auto; padding:18px 22px}
  .brandbar{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; text-align:center;}

  .brand{display:flex; align-items:center; gap:14px; position:relative; padding:8px 14px; border-radius:16px;
         background: linear-gradient(180deg, rgba(88,183,255,.14), rgba(34,224,107,.10));
         border:1px solid rgba(88,183,255,.22);
         box-shadow: inset 0 0 30px rgba(88,183,255,.12), 0 12px 26px rgba(0,0,0,.45);
  }

  .logo{
    width:58px; height:58px; border-radius:14px;
    background: conic-gradient(from 210deg, #0e2633, #1b3647);
    box-shadow: 0 0 0 3px rgba(88,183,255,.25),
                0 18px 30px rgba(0,0,0,.55),
                inset 0 0 38px rgba(88,183,255,.35);
    position:relative; overflow:hidden;
  }
  .logo::after{
    content:""; position:absolute; inset:-30% -20%;
    background: linear-gradient(120deg, transparent 45%, rgba(255,255,255,.22) 50%, transparent 55%);
    animation: glint 4.2s ease-in-out infinite;
  }
  @keyframes glint { 0%{ transform: translateX(-20%);} 50%{ transform: translateX(20%);} 100%{ transform: translateX(-20%);} }

  .title{display:flex; flex-direction:column; gap:4px}
  .title .h1{
    font-weight:1000; letter-spacing:1.2px; font-size:28px; text-transform:uppercase;
    background: linear-gradient(90deg, #ffffff, #97d7ff 30%, #6ff0a4 60%, #ffb3b3 90%, #ffffff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    filter: drop-shadow(0 2px 0 rgba(0,0,0,.6));
    animation: hue 12s linear infinite; background-size: 200% 100%;
  }
  @keyframes hue { to { background-position: 200% 0; } }
  .title .sub{color:#d7e7ff; font-size:12px; letter-spacing:.35px; opacity:.9}

  nav.tabs{display:flex; gap:12px; justify-content:center}
  nav.tabs a{
    text-decoration:none; color:#f5fbff; border:1px solid rgba(88,183,255,.3);
    padding:10px 16px; border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    box-shadow: 0 8px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    font-weight:800; letter-spacing:.5px; transform: skewX(-6deg);
  }
  nav.tabs a:hover{ transform: translateY(-1px) skewX(-6deg); }

  .banner{ position:relative; margin-top:14px; border-radius:var(--radius); overflow:hidden; border:1px solid var(--border);
    background: linear-gradient(180deg, #23282e 0%, #121519 100%);
    box-shadow: inset 0 2px 0 rgba(255,255,255,.12), inset 0 -2px 0 rgba(88,183,255,.24), 0 12px 34px rgba(0,0,0,.38);
    height:320px; }
  .banner__products{ position:absolute; left:0; right:0; top:0; height:260px; }
  .banner__words{ position:absolute; left:0; right:0; bottom:0; height:60px; background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.42)); border-top:1px solid rgba(255,255,255,.06); }

  .ticker__viewport{ position:relative; width:100%; height:100%; overflow:hidden; }
  .ticker__track{ position:absolute; inset:0; display:flex; gap:28px; align-items:center; padding:12px 22px;
                   animation: slideRight var(--duration) linear infinite; will-change: transform; }
  .banner:hover .ticker__track{ animation-play-state: paused; }
  .item{ flex:0 0 auto; display:flex; align-items:center; justify-content:center; height:100%; min-width:270px; }
  .pill {
    min-width:220px; height:120px; border-radius:20px; border:1px solid rgba(255,255,255,.12);
    display:flex; align-items:center; justify-content:center; padding:16px;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    box-shadow: 0 16px 36px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    font-weight:900; letter-spacing:.8px; text-transform:uppercase;
  }
  .pill span{filter: drop-shadow(0 4px 16px rgba(0,0,0,.5));}
  .pill--blue{ background: radial-gradient(400px 140px at 30% 20%, rgba(88,183,255,.22), transparent 50%), linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
  .pill--green{ background: radial-gradient(400px 140px at 30% 20%, rgba(34,224,107,.20), transparent 50%), linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
  .pill--orange{ background: radial-gradient(400px 140px at 30% 20%, rgba(255,179,79,.22), transparent 50%), linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); }
  @keyframes slideRight{ from { transform: translateX(-50%); } to { transform: translateX(0%); } }

  .words__viewport{ position:relative; width:100%; height:100%; overflow:hidden; }
  .words__track{ position:absolute; inset:0; display:flex; gap:40px; align-items:center; padding:0 22px;
                 animation: slideLeft calc(var(--duration) * 0.9) linear infinite; will-change: transform; }
  .word{ font-weight:900; letter-spacing:.7px; text-transform:uppercase; font-size:14px; color:#f1f3f5; white-space:nowrap; opacity:.98;
         text-shadow: 0 0 10px rgba(255,255,255,.08), 0 0 24px rgba(88,183,255,.25);}
  .word::before{ content:"•"; margin-right:12px; opacity:.55 }
  .word:first-child::before{ content:"" }
  @keyframes slideLeft{ from { transform: translateX(0%); } to { transform: translateX(-50%); } }

  .bar{width:100%; height:2px; margin-top:14px; background: linear-gradient(90deg, var(--accent2), var(--accent), var(--accent3)); border-radius:999px; box-shadow: 0 0 24px rgba(88,183,255,.35), 0 0 24px rgba(34,224,107,.35), 0 0 24px rgba(255,107,107,.25);}
  .controls{display:grid; grid-template-columns: 1fr auto auto auto; gap:12px; margin-top:14px;}
  select, button, input{appearance:none; background:var(--glass); color:var(--text); border:1px solid var(--border); border-radius: var(--radius); padding:12px 14px; font-size:14px; box-shadow: var(--shadow); transition: transform .08s ease, border-color .2s ease, box-shadow .2s ease;}
  button:hover{transform: translateY(-1px)} .primary{border-color: rgba(88,183,255,.35); background: linear-gradient(180deg, rgba(88,183,255,.18), rgba(88,183,255,.08));}

  main .wrap{max-width:1200px; margin:24px auto; padding:0 22px}
  .panel{background: var(--card); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom:18px;}
  .head{display:flex; justify-content:space-between; align-items:flex-end; padding:18px; border-bottom:1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));}
  .name{font-size:28px; font-weight:900; letter-spacing:.4px; line-height:1.1; text-shadow: 0 0 10px rgba(88,183,255,.12);}
  .capsule{display:flex; gap:8px; flex-wrap:wrap}
  .chip{font-size:12px; color:var(--muted); border:1px solid var(--border); border-radius:999px; padding:6px 10px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));}
  .kpis{display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:12px; padding:16px;}
  .kpi{background: var(--glass); border:1px solid var(--border); border-radius:14px; padding:14px; min-height:92px; position:relative; overflow:hidden;}
  .kpi .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px}
  .kpi .value{font-size:20px; font-weight:800; margin-top:6px}
  .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; padding:0 16px 16px 16px;}
  .card{background: var(--glass); border:1px solid var(--border); border-radius:14px; padding:12px; transition: transform .08s ease; min-height:88px; position:relative; overflow:hidden;}
  .card:hover{ transform: translateY(-1px)}
  .card h4{margin:0 0 8px 0; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px}
  .card .value{font-size:16px; font-weight:700}
  .actions{display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid var(--border)}
  @media print{ header.hero, .actions { display:none !important; } }

  /* VPD styles */
  .vpd-controls{display:grid; grid-template-columns: repeat(6, minmax(120px,1fr)); gap:10px; padding:16px;}
  .vpd-out{display:grid; grid-template-columns: repeat(3,1fr); gap:12px; padding:0 16px 16px;}
  .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); font-size:12px; color:var(--muted)}
  .gauge{height:16px; border-radius:999px; background:#0f1115; border:1px solid var(--border); overflow:hidden; box-shadow: inset 0 0 10px rgba(0,0,0,.4);}
  .gauge > div{height:100%; width:0%; background: linear-gradient(90deg, var(--accent2), var(--accent), var(--accent3)); transition: width .25s ease;}
  .status{font-weight:900; letter-spacing:.5px}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.bad{color:var(--bad)}
  .blink{ animation: blink .9s steps(2, start) infinite; }
  @keyframes blink{ to{ opacity:.25 } }

  /* IA styles */
  .drop{ border:1px dashed rgba(255,255,255,.2); border-radius:14px; padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
  .drop .left{display:grid; gap:10px}
  .thumb{width:100%; aspect-ratio: 4/3; background:#0c0f12; border:1px solid var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;}
  .thumb img{max-width:100%; max-height:100%}
  .thumb canvas{max-width:100%; height:auto}
  .results{display:grid; gap:10px}
  .resline{display:flex; justify-content:space-between; gap:8px; align-items:center}
  .confidence{height:10px; border-radius:999px; background:#0f1115; border:1px solid var(--border); overflow:hidden; width:40%}
  .confidence > div{height:100%; width:0%; background: linear-gradient(90deg, var(--accent2), var(--accent));}
</style>
</head>
<body>
<header class="hero">
  <div class="container">
    <div class="brandbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <div class="h1">4ELEMENTS Diagnostic PRO</div>
          <div class="sub">Power • Precision • Control</div>
        </div>
      </div>
      <nav class="tabs">
        <a href="#ficha">Ficha</a>
        <a href="#vpd">VPD</a>
        <a href="#diag">Diagnóstico IA</a>
        <a href="https://www.pro4elements.com" target="_blank" rel="noopener">Tienda</a>
      </nav>
    </div>

    <div class="banner">
      <div class="banner__products">
        <div class="ticker__viewport">
          <div class="ticker__track" id="prodTrack"></div>
        </div>
      </div>
      <div class="banner__words">
        <div class="words__viewport">
          <div class="words__track" id="wordsTrack"></div>
        </div>
      </div>
    </div>

    <div class="bar"></div>
    <div class="controls">
      <select id="geneSelect" aria-label="Seleccionar genética"></select>
      <button id="btnPDF" class="primary">Exportar PDF</button>
      <button id="btnCSV">Exportar CSV</button>

      <!-- Importador y packer -->
      <label class="badge" style="display:flex;align-items:center;gap:8px">
        Cargar DATA (v17)
        <input type="file" id="fileV17" accept=".html,.htm" />
      </label>
      <button id="btnPack" title="Guardar versión con DATA">Guardar HTML con DATA</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- PANEL FICHA -->
  <section class="panel" id="ficha">
    <div class="head">
      <div>
        <div id="genName" class="name">Selecciona una genética</div>
        <div class="capsule" id="caps"></div>
      </div>
      <div class="chip" id="countChip"></div>
    </div>
    <div class="kpis" id="kpis"></div>
    <div class="grid" id="grid"></div>
    <div class="actions"><button id="btnTop" title="Subir arriba">Subir ↑</button></div>
  </section>

  <!-- PANEL VPD -->
  <section class="panel" id="vpd">
    <div class="head">
      <div class="name">Calculadora de VPD</div>
      <div class="capsule">
        <span class="chip">Independiente del resto</span>
        <span class="chip">Rangos por etapa</span>
        <span class="chip">Alerta fuera de rango</span>
      </div>
    </div>
    <div class="vpd-controls">
      <label class="badge">Etapa
        <select id="stage">
          <option value="veg">Vegetativo</option>
          <option value="flo">Floración</option>
        </select>
      </label>
      <label class="badge">Fase
        <select id="phase">
          <option value="inicio">Inicio</option>
          <option value="media" selected>Media</option>
          <option value="final">Final</option>
        </select>
      </label>
      <label class="badge">Tª aire (°C)
        <input type="number" id="tair" value="26" step="0.1"/>
      </label>
      <label class="badge">% HR
        <input type="number" id="rh" value="60" step="0.1"/>
      </label>
      <label class="badge">Usar Tª hoja
        <input type="checkbox" id="leafChk"/>
      </label>
      <label class="badge">ΔT hoja-aire (°C)
        <input type="number" id="dleaf" value="-1" step="0.1"/>
      </label>
    </div>
    <div class="vpd-out">
      <div class="card">
        <h4>VPD aire (kPa) — objetivo</h4>
        <div class="value"><span id="vpdAir" class="status">—</span></div>
        <div class="gauge" aria-hidden="true"><div id="gAir"></div></div>
        <div class="chip" id="targetAir">Objetivo —</div>
      </div>
      <div class="card">
        <h4>VPD hoja (kPa)</h4>
        <div class="value"><span id="vpdLeaf" class="status">—</span></div>
        <div class="gauge" aria-hidden="true"><div id="gLeaf"></div></div>
        <div class="chip">ΔT hoja-aire aplicado cuando esté activado</div>
      </div>
      <div class="card">
        <h4>%HR objetivo para tu Tª</h4>
        <div class="value"><span id="rhTarget" class="status">—</span></div>
        <div class="gauge" aria-hidden="true"><div id="gRh"></div></div>
        <div class="chip">Se calcula a partir del rango VPD recomendado</div>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="btnVPD">Calcular</button>
      <button id="btnVPDReset">Reset</button>
    </div>
  </section>

  <!-- PANEL DIAGNÓSTICO IA -->
  <section class="panel" id="diag">
    <div class="head">
      <div class="name">Diagnóstico por imagen — IA local (offline) + IA web (si hay conexión)</div>
      <div class="capsule">
        <span class="chip" id="netState">Estado: comprobando…</span>
        <span class="chip">Privado: análisis en el navegador</span>
      </div>
    </div>
    <div class="drop">
      <div class="left">
        <label class="badge">Sube una foto (.jpg/.png)
          <input type="file" id="file" accept="image/*"/>
        </label>
        <div class="thumb" id="thumb"><span>Sin imagen</span></div>
        <div class="actions">
          <button class="primary" id="btnAnalyzeLocal">Analizar (IA local)</button>
          <button id="btnAnalyzeWeb">Analizar (IA web)</button>
        </div>
      </div>
      <div class="results">
        <div class="card">
          <h4>Resultados</h4>
          <div id="res"></div>
        </div>
        <div class="card">
          <h4>Acciones sugeridas</h4>
          <div id="actions">—</div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Aquí incrustaremos la DATA cuando guardes la versión final -->
<script id="data-embed" type="application/json">__DATA_PLACEHOLDER__</script>

<script>
/* ---------- Banner products + palabras ---------- */
const products = [
  {name:'BASE', cls:'pill pill--blue'}, {name:'GROWTH', cls:'pill pill--green'},
  {name:'BLOOM', cls:'pill pill--orange'}, {name:'Atom K', cls:'pill pill--orange'},
  {name:'Atom Forze', cls:'pill pill--blue'}, {name:'Sugar Rezum', cls:'pill pill--green'},
  {name:'Glutton Bloom', cls:'pill pill--orange'}, {name:'Ultra Booster', cls:'pill pill--blue'},
  {name:'Ultra Bigger', cls:'pill pill--green'}, {name:'Hardcore Roots', cls:'pill pill--blue'}
];
const words = ['EC precisa','PPFD óptimo','CO₂ controlado','DLI calculado','VPD estable','Calidad máxima','Resina top','Aroma intacto','Cosecha pro','4ELEMENTS'];
function fillTicker() {
  const track = document.getElementById('prodTrack');
  const wtrack = document.getElementById('wordsTrack');
  const list = [...products, ...products];
  list.forEach(p => {
    const it = document.createElement('div'); it.className='item';
    const pill = document.createElement('div'); pill.className=p.cls;
    const span=document.createElement('span'); span.textContent=p.name;
    pill.appendChild(span); it.appendChild(pill); track.appendChild(it);
  });
  const ww = [...words, ...words, ...words];
  ww.forEach(w => {
    const el = document.createElement('div'); el.className='word'; el.textContent = w;
    wtrack.appendChild(el);
  });
}
fillTicker();

/* ---------- DATA: leer la embebida (si existe) o quedar vacía ---------- */
let DATA = [];
(() => {
  const embed = document.getElementById('data-embed');
  if(embed && embed.textContent && embed.textContent.trim() !== '__DATA_PLACEHOLDER__'){
    try { DATA = JSON.parse(embed.textContent); } catch(e){}
  }
})();

const COLUMNS = ["Genética","Origen","THC %","EC Veg","EC Flor","PPFD Veg","PPFD max (sin CO2)","PPFD Flor max (con CO2)","Temperatura Día (°C)","Temperatura Noche (°C)","Humedad Veg (%)","Humedad Flor (%)","Semanas Floración","Secado (días)","Secado HR (%)","Secado Temp (°C)","Stretch","Tipo de flor","Sensibilidad a nutrientes","Ratio hoja","CO2 Max (ppm)","Recomendaciones"];

/* ---------- UI de ficha genética ---------- */
const geneSelect = document.getElementById('geneSelect');
const genName = document.getElementById('genName');
const kpis = document.getElementById('kpis');
const grid = document.getElementById('grid');
const caps = document.getElementById('caps');
const countChip = document.getElementById('countChip');

function populateGeneSelect(){
  const list = DATA && DATA.length ? [...DATA].sort((a,b)=> (a["Genética"]||"").localeCompare(b["Genética"]||"")) : [];
  geneSelect.innerHTML = '<option value="">— Elegir genética —</option>' + list.map((d,i)=>`<option value="${i}">${d["Genética"]}</option>`).join('');
  geneSelect.dataset.mapFromSorted = JSON.stringify(list.map(d => (DATA||[]).indexOf(d)));
  countChip.textContent = `${DATA?.length||0} genéticas`;
}

function renderGene(idx){
  if(idx===""||idx==null){ genName.textContent="Selecciona una genética"; kpis.innerHTML=""; grid.innerHTML=""; caps.innerHTML=""; return; }
  const mapIdx = JSON.parse(geneSelect.dataset.mapFromSorted||"[]")[Number(idx)] ?? Number(idx);
  const d = DATA[mapIdx];
  genName.textContent = d["Genética"] || "—";
  caps.innerHTML = `
    <span class="chip">${d["Origen"]||"—"}</span>
    <span class="chip">${d["THC %"]||"—"} THC</span>
    <span class="chip">Stretch: ${d["Stretch"]||"—"}</span>
    <span class="chip">Floración: ${d["Semanas Floración"]||"—"} sem</span>
  `;
  const klist = [
    ["EC Veg", d["EC Veg"]], ["EC Flor", d["EC Flor"]],
    ["PPFD Veg", d["PPFD Veg"]], ["PPFD Flor max (con CO2)", d["PPFD Flor max (con CO2)"]],
    ["CO2 Max (ppm)", d["CO2 Max (ppm)"]]
  ];
  kpis.innerHTML = klist.map(([l,v])=>`<div class="kpi"><div class="label">${l}</div><div class="value">${v??"—"}</div></div>`).join('');
  const cards = [
    ["Temperatura Día (°C)", d["Temperatura Día (°C)"]],
    ["Temperatura Noche (°C)", d["Temperatura Noche (°C)"]],
    ["Humedad Veg (%)", d["Humedad Veg (%)"]],
    ["Humedad Flor (%)", d["Humedad Flor (%)"]],
    ["Secado (días)", d["Secado (días)"]],
    ["Secado HR (%)", d["Secado HR (%)"]],
    ["Secado Temp (°C)", d["Secado Temp (°C)"]],
    ["Tipo de flor", d["Tipo de flor"]],
    ["Ratio hoja", d["Ratio hoja"]],
    ["Sensibilidad a nutrientes", d["Sensibilidad a nutrientes"]],
    ["Recomendaciones", d["Recomendaciones"]],
  ];
  grid.innerHTML = cards.map(([h,v])=>{
    if(h==="Secado HR (%)"){
      let val = v;
      if(typeof v==="number" && v>60) val = `<span class="status bad blink">${v}% (fuera de rango)</span>`;
      if(typeof v==="string"){
        const m = v.match(/(\d+)\D+(\d+)/);
        const hi = m ? parseInt(m[2]) : parseInt(v);
        if(hi>60) val = `<span class="status bad blink">${v} (fuera de rango)</span>`;
      }
      return `<div class="card"><h4>${h}</h4><div class="value">${val}</div></div>`;
    }
    return `<div class="card"><h4>${h}</h4><div class="value">${(v??"—")}</div></div>`;
  }).join('');
}

geneSelect.addEventListener('change', e=>renderGene(e.target.value));
document.getElementById('btnTop').addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
populateGeneSelect();

/* ---------- Export CSV / PDF ---------- */
document.getElementById('btnCSV').addEventListener('click', ()=>{
  const rows = [COLUMNS.join(','), ...(DATA||[]).map(d=>COLUMNS.map(c=>JSON.stringify(d[c]??"")).join(','))];
  const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'geneticas_4Elements.csv'; a.click();
});
document.getElementById('btnPDF').addEventListener('click', ()=> window.print());

/* ---------- VPD ---------- */
const stage = document.getElementById('stage');
const phase = document.getElementById('phase');
const tair = document.getElementById('tair');
const rh = document.getElementById('rh');
const leafChk = document.getElementById('leafChk');
const dleaf = document.getElementById('dleaf');
const vpdAirEl = document.getElementById('vpdAir');
const vpdLeafEl = document.getElementById('vpdLeaf');
const rhTargetEl = document.getElementById('rhTarget');
const gAir = document.getElementById('gAir');
const gLeaf = document.getElementById('gLeaf');
const gRh = document.getElementById('gRh');
const targetAir = document.getElementById('targetAir');

const VPD_RANGES = {
  veg: { inicio:[0.7,0.9], media:[0.8,1.1], final:[0.9,1.2] },
  flo: { inicio:[1.1,1.3], media:[1.2,1.5], final:[1.3,1.6] }
};
function svp_kPa(T){ return 0.6108 * Math.exp((17.27*T)/(T+237.3)); }
function vpd_kPa(T, RH){ const es = svp_kPa(T); return Math.max(0, es * (1 - Math.max(0,Math.min(100, RH))/100)); }
function statusClass(val, min, max){ if(val < min*0.94 || val > max*1.06) return 'bad'; if(val < min || val > max) return 'warn'; return 'ok'; }
function pctBetween(val, min, max){ const lo = Math.max(0, min-0.3), hi = max+0.3; return Math.max(0, Math.min(100, ((val - lo)/(hi - lo))*100)); }
function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

function updateVPD(){
  const st = stage.value, ph = phase.value;
  const [minV, maxV] = VPD_RANGES[st][ph];
  const T = parseFloat(tair.value||'0');
  const RH = parseFloat(rh.value||'0');
  const es = svp_kPa(T);
  const vpdAir = vpd_kPa(T, RH);
  let vpdLeaf = vpdAir;
  if(leafChk.checked){
    const d = parseFloat(dleaf.value||'0');
    const Tleaf = T + d;
    vpdLeaf = vpd_kPa(Tleaf, RH);
  }
  const rhMax = clamp(100*(1 - (minV/es)), 0, 100);
  const rhMin = clamp(100*(1 - (maxV/es)), 0, 100);

  vpdAirEl.textContent = vpdAir.toFixed(2);
  vpdLeafEl.textContent = vpdLeaf.toFixed(2);
  rhTargetEl.textContent = `${rhMin.toFixed(0)}–${rhMax.toFixed(0)} %`;
  targetAir.textContent = `Objetivo ${minV.toFixed(1)}–${maxV.toFixed(1)} kPa (${st==='veg'?'Veg':'Floración'} • ${ph})`;

  const stAir = statusClass(vpdAir, minV, maxV);
  vpdAirEl.className = 'status ' + stAir + (stAir!=='ok' ? ' blink':'');

  gAir.style.width = pctBetween(vpdAir, minV, maxV)+'%';
  const stLeaf = statusClass(vpdLeaf, minV, maxV);
  vpdLeafEl.className = 'status ' + stLeaf + (stLeaf!=='ok' ? ' blink':'');
  gLeaf.style.width = pctBetween(vpdLeaf, minV, maxV)+'%';

  const rNow = clamp(RH,0,100);
  const rMid = (rhMin+rhMax)/2;
  gRh.style.width = clamp(100 - Math.abs(rNow - rMid)/( (rhMax-rhMin)/2 + 1e-6 )*100, 0, 100)+'%';
}
['input','change'].forEach(evt=>{
  [stage, phase, tair, rh, leafChk, dleaf].forEach(el => el.addEventListener(evt, updateVPD));
});
document.getElementById('btnVPD').addEventListener('click', updateVPD);
document.getElementById('btnVPDReset').addEventListener('click', ()=>{
  stage.value='veg'; phase.value='media'; tair.value=26; rh.value=60; leafChk.checked=false; dleaf.value=-1; updateVPD();
});
updateVPD();

/* ---------- Diagnóstico IA ---------- */
const netState = document.getElementById('netState');
function setNetState(){
  netState.textContent = 'Estado: ' + (navigator.onLine ? 'conexión activa' : 'sin conexión');
}
window.addEventListener('online', setNetState);
window.addEventListener('offline', setNetState);
setNetState();

const fileInput = document.getElementById('file');
const thumb = document.getElementById('thumb');
let imgBitmap = null;
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  thumb.innerHTML='';
  const img = document.createElement('img'); img.src = url; img.onload = ()=> URL.revokeObjectURL(url);
  thumb.appendChild(img);
  imgBitmap = await createImageBitmap(f);
});

function analyzeHeuristic(bitmap){
  const W = 320, H = 240;
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bitmap, 0, 0, W, H);
  const data = ctx.getImageData(0,0,W,H).data;
  let n = W*H, yellow=0, necrosis=0, white=0, greenSum=0, g2=0;
  for(let i=0;i<data.length;i+=4){
    const r=data[i], g=data[i+1], b=data[i+2];
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    const v = max;
    const s = max===0?0: (max-min)/max;
    let h=0;
    if(max===min){ h=0; } else if(max===r){ h = 60 * ((g-b)/(max-min)) + (g<b?360:0); }
    else if(max===g){ h = 60 * ((b-r)/(max-min)) + 120; }
    else { h = 60 * ((r-g)/(max-min)) + 240; }
    if(h>35 && h<65 && s>0.15 && v>80) yellow++;
    if(v<55 || (s>0.4 && h>10 && h<40 && v<90)) necrosis++;
    if(v>230 && s<0.15) white++;
    greenSum += g; g2 += g*g;
  }
  const yp = yellow/n*100, np = necrosis/n*100, wp = white/n*100;
  const gMean = greenSum/n, gStd = Math.sqrt( g2/n - gMean*gMean );
  const hypos = [];
  if(yp>12 && gMean<110){ hypos.push({name:'Clorosis general (posible déficit de N)', score: Math.min(1, (yp-10)/20 + (120-gMean)/80 )}); }
  if(np>3 && yp>6){ hypos.push({name:'Bordes quemados/necrosis marginal (K bajo o exceso de sales)', score: Math.min(1, (np-3)/7 + (yp-6)/20 )}); }
  else if(np>4){ hypos.push({name:'Necrosis y puntas quemadas (exceso de fertilización/sales)', score: Math.min(1, (np-4)/10 )}); }
  if(yp>8 && gStd>35){ hypos.push({name:'Clorosis internerval (posible déficit de Mg)', score: Math.min(1, (yp-8)/20 + (gStd-30)/50 )}); }
  if(wp>1.5){ hypos.push({name:'Manchas blancas (posible oídio)', score: Math.min(1, (wp-1)/8 )}); }
  if(yp<6 && np<2 && wp<0.8){ hypos.push({name:'Tejido aparentemente sano', score:0.6}); }
  hypos.sort((a,b)=>b.score-a.score);
  return {hypos, stats:{yellow:yp, necrosis:np, white:wp, gMean, gStd}, canvas};
}

function renderResults(result, modeLabel){
  const res = document.getElementById('res');
  const actions = document.getElementById('actions');
  if(!result){ res.innerHTML='Sube una imagen primero.'; actions.textContent='—'; return; }
  const {hypos, stats, canvas} = result;
  thumb.innerHTML=''; thumb.appendChild(canvas);
  res.innerHTML = hypos.slice(0,3).map(h=>{
    const pct = Math.round(h.score*100);
    return `<div class="resline"><div>${h.name} <span class="chip">${modeLabel}</span></div><div class="confidence"><div style="width:${pct}%"></div></div></div>`;
  }).join('') + 
  `<div class="chip">Métricas — Amarillo: ${stats.yellow.toFixed(1)}% • Necrosis: ${stats.necrosis.toFixed(1)}% • Blanco: ${stats.white.toFixed(1)}% • G media: ${stats.gMean.toFixed(0)} (±${stats.gStd.toFixed(0)})</div>`;
  const top = hypos[0]?.name || '';
  let txt = '—';
  if(top.includes('N)')) txt = 'Revisar EC total; subir N en crecimiento o corregir desbalance. Aportar nitrato cálcico o base con N nítrico. Evitar excesos de riego.';
  else if(top.includes('Mg')) txt = 'Añadir Mg (0.2–0.4 g/L MgSO₄ heptahidratado) o suplemento Ca/Mg. Ajustar pH 5.8–6.2.';
  else if(top.includes('oídio')) txt = 'Mejorar ventilación y HR; tratar con bicarbonato potásico/azufre mojable; retirar hojas afectadas.';
  else if(top.includes('sales')) txt = 'Lavar con solución de EC baja; comprobar drenaje y acumulación de sales; reanudar con EC gradual.';
  else if(top.includes('Tejido')) txt = 'Sin signos evidentes. Mantener VPD dentro de rango y nutrición estable.';
  actions.textContent = txt;
}

document.getElementById('btnAnalyzeLocal').addEventListener('click', async ()=>{
  if(!imgBitmap){ alert('Primero sube una imagen.'); return; }
  const r = analyzeHeuristic(imgBitmap);
  renderResults(r, 'IA local (offline)');
});

async function ensureTF(){
  if(window.tf) return true;
  if(!navigator.onLine) return false;
  return new Promise((resolve)=>{
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js';
    s.onload = ()=> resolve(true);
    s.onerror = ()=> resolve(false);
    document.head.appendChild(s);
  });
}
document.getElementById('btnAnalyzeWeb').addEventListener('click', async ()=>{
  if(!imgBitmap){ alert('Primero sube una imagen.'); return; }
  const ok = await ensureTF();
  const r = analyzeHeuristic(imgBitmap);
  renderResults(r, ok ? 'IA web (mejorada)' : 'IA web (sin conexión, usando local)');
});

/* ---------- Importar DATA desde tu v17 y empaquetar ---------- */
const fileV17 = document.getElementById('fileV17');
fileV17.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  const m = text.match(/const\s+DATA\s*=\s*(\[[\s\S]*?\]);/);
  if(!m){ alert('No se encontró const DATA en ese archivo.'); return; }
  try{
    // Eval seguro del array (viene como literal JS)
    const arr = (new Function('return ' + m[1]))();
    if(!Array.isArray(arr) || !arr.length){ alert('DATA vacío.'); return; }
    DATA = arr;
    populateGeneSelect();
    alert(`Cargadas ${DATA.length} genéticas ✔`);
  }catch(err){
    console.error(err);
    alert('No pude parsear la DATA. Revisa el archivo.');
  }
});

document.getElementById('btnPack').addEventListener('click', ()=>{
  if(!DATA || !DATA.length){ alert('Primero carga la DATA desde tu v17.'); return; }
  // Construimos una copia del HTML actual sustituyendo el marcador __DATA_PLACEHOLDER__ por la DATA real (JSON)
  const html = document.documentElement.outerHTML.replace('__DATA_PLACEHOLDER__', JSON.stringify(DATA));
  const blob = new Blob([html], {type:'text/html;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = '4ELEMENTS_Diagnostic_PRO_FULL_single.html';
  a.click();
});
</script>
</body>
</html>
